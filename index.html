<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trimble (TRMB) Share Price</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f0f0f0;
        }
        #price-container, #chart-container, #combined-chart-container, #nasdaq-chart-container {
            text-align: center;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            width: 80%;
            max-width: 800px;
        }
        #price, #exchange-rate {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin: 5px 0;
        }
        #datetime {
            font-size: 1em;
            color: #666;
            margin-top: 5px;
        }
        canvas {
            width: 100% !important;
            height: auto !important;
        }
    </style>
</head>
<body>
    <div id="price-container">
        <div id="price">Loading...</div>
        <div id="exchange-rate">Loading exchange rate...</div>
        <div id="datetime"></div>
    </div>
    <div id="combined-chart-container">
        <canvas id="combinedChart"></canvas>
    </div>
    <div id="chart-container">
        <canvas id="priceChart"></canvas>
    </div>
    <div id="nasdaq-chart-container">
        <canvas id="nasdaqChart"></canvas>
    </div>

    <script>
        async function fetchStockData() {
            const symbol = 'TRMB';
            const range = '3mo';
            const interval = '1d';
            const apiUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=${range}&interval=${interval}`;

            try {
                const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(apiUrl)}`);
                const data = await response.json();
                console.log('Stock API Response:', data); // For debugging

                if (data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    const currentPrice = result.meta.regularMarketPrice.toFixed(2);
                    document.getElementById('price').textContent = `TRMB    $${currentPrice}`;

                    // Get current date and time for Stockholm
                    const stockholmTime = new Date().toLocaleString('en-US', {
                        timeZone: 'Europe/Stockholm',
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });

                    const formattedDateTime = stockholmTime.replace(/(\d+)\/(\d+)\/(\d+),/, '$3-$1-$2').replace(/,/, '');
                    document.getElementById('datetime').textContent = formattedDateTime;

                    const timestamps = result.timestamp;
                    const prices = result.indicators.quote[0].close;

                    // Fetch exchange rate data
                    const exchangeRates = await fetchExchangeRates(timestamps[0], timestamps[timestamps.length - 1]);
                    
                    // Fetch NASDAQ data
                    const nasdaqData = await fetchNasdaqData(timestamps[0], timestamps[timestamps.length - 1]);
                    
                    createCombinedChart(timestamps, prices, exchangeRates);
                    createChart(timestamps, prices, exchangeRates);
                    createNasdaqChart(timestamps, prices, nasdaqData);
                } else {
                    throw new Error('Unable to fetch the stock data');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('price').textContent = 'Error fetching data';
                document.getElementById('exchange-rate').textContent = 'Error fetching exchange rate';
                document.getElementById('datetime').textContent = '';
            }
        }

        async function fetchExchangeRates(startTimestamp, endTimestamp) {
            const symbol = 'SEK=X';
            const range = '3mo';
            const interval = '1d';
            const apiUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=${range}&interval=${interval}`;

            try {
                const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(apiUrl)}`);
                const data = await response.json();
                console.log('Exchange Rate API Response:', data); // For debugging

                if (data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    const timestamps = result.timestamp;
                    const rates = result.indicators.quote[0].close;

                    // Display current exchange rate
                    const currentRate = result.meta.regularMarketPrice.toFixed(2);
                    document.getElementById('exchange-rate').textContent = `1 USD = ${currentRate} SEK`;

                    // Create an object with dates as keys and rates as values
                    const exchangeRates = {};
                    timestamps.forEach((ts, index) => {
                        const date = new Date(ts * 1000).toISOString().split('T')[0];
                        exchangeRates[date] = { SEK: rates[index] };
                    });

                    return exchangeRates;
                } else {
                    throw new Error('Unable to fetch the exchange rate data');
                }
            } catch (error) {
                console.error('Error fetching exchange rates:', error);
                document.getElementById('exchange-rate').textContent = 'Error fetching exchange rate';
                document.getElementById('datetime').textContent = '';
                return null;
            }
        }

        async function fetchNasdaqData(startTimestamp, endTimestamp) {
            const symbol = '^IXIC';
            const range = '3mo';
            const interval = '1d';
            const apiUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=${range}&interval=${interval}`;

            try {
                const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(apiUrl)}`);
                const data = await response.json();
                console.log('NASDAQ API Response:', data);

                if (data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    const timestamps = result.timestamp;
                    const prices = result.indicators.quote[0].close;

                    return timestamps.map((ts, index) => ({
                        x: new Date(ts * 1000),
                        y: prices[index]
                    }));
                } else {
                    throw new Error('Unable to fetch the NASDAQ data');
                }
            } catch (error) {
                console.error('Error fetching NASDAQ data:', error);
                return null;
            }
        }

        function createChart(timestamps, prices, exchangeRates) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // Calculate average price
            const averagePrice = prices.reduce((sum, price) => sum + price, 0) / prices.length;
            
            // Prepare data for chart
            const chartData = timestamps.map((ts, index) => {
                const date = new Date(ts * 1000);
                const dateString = date.toISOString().split('T')[0];
                return {
                    x: date,
                    y: prices[index],
                    exchangeRate: exchangeRates && exchangeRates[dateString] ? exchangeRates[dateString].SEK : null
                };
            });

            // Filter out any null exchange rates
            const exchangeRateData = chartData
                .filter(item => item.exchangeRate !== null)
                .map(item => ({x: item.x, y: item.exchangeRate}));

            // Calculate average exchange rate
            const averageExchangeRate = exchangeRateData.reduce((sum, item) => sum + item.y, 0) / exchangeRateData.length;

            new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'TRMB',
                        data: chartData,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        yAxisID: 'y'
                    }, {
                        label: 'Average Price',
                        data: [{x: new Date(timestamps[0] * 1000), y: averagePrice}, 
                               {x: new Date(timestamps[timestamps.length - 1] * 1000), y: averagePrice}],
                        borderColor: 'rgb(75, 192, 192)',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0,
                        yAxisID: 'y'
                    }, {
                        label: 'USD → SEK ',
                        data: exchangeRateData,
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1,
                        yAxisID: 'y1'
                    }, {
                        label: 'Average Exchange Rate',
                        data: [{x: new Date(timestamps[0] * 1000), y: averageExchangeRate}, 
                               {x: new Date(timestamps[timestamps.length - 1] * 1000), y: averageExchangeRate}],
                        borderColor: 'rgb(255, 99, 132)',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                displayFormats: {
                                    month: 'MMM d'
                                }
                            },
                            title: {
                                display: false
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    const date = new Date(value);
                                    if (date.getDate() === 1) {
                                        return date.toLocaleString('en-US', { month: 'short', day: 'numeric' });
                                    }
                                    return '';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'TRMB [USD]',
                                color: 'rgb(75, 192, 192)'  // Match the TRMB line color
                            },
                            position: 'left',
                            ticks: {
                                color: 'rgb(75, 192, 192)'  // Match the TRMB line color
                            }
                        },
                        y1: {
                            title: {
                                display: true,
                                text: 'USD → SEK',
                                color: 'rgb(255, 99, 132)'  // Match the exchange rate line color
                            },
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                color: 'rgb(255, 99, 132)'  // Match the exchange rate line color
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                filter: function(item, chart) {
                                    // Hide both "Average Price" and "Average Exchange Rate" from the legend
                                    return item.text !== 'Average Price' && item.text !== 'Average Exchange Rate';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createCombinedChart(timestamps, prices, exchangeRates) {
            const ctx = document.getElementById('combinedChart').getContext('2d');
            
            // Prepare data for chart
            const chartData = timestamps.map((ts, index) => {
                const date = new Date(ts * 1000);
                const dateString = date.toISOString().split('T')[0];
                const exchangeRate = exchangeRates && exchangeRates[dateString] ? exchangeRates[dateString].SEK : null;
                return {
                    x: date,
                    y: exchangeRate !== null ? prices[index] * exchangeRate : null
                };
            }).filter(item => item.y !== null);

            // Calculate average price in SEK
            const averagePriceSEK = chartData.reduce((sum, item) => sum + item.y, 0) / chartData.length;

            // Calculate percent deviation and merge with price data
            const mergedData = chartData.map(item => ({
                x: item.x,
                y: item.y,
                y1: ((item.y / averagePriceSEK) - 1) * 100
            }));

            // Calculate y-axis ranges
            const minPrice = Math.min(...mergedData.map(item => item.y));
            const maxPrice = Math.max(...mergedData.map(item => item.y));
            const minPercent = Math.min(...mergedData.map(item => item.y1));
            const maxPercent = Math.max(...mergedData.map(item => item.y1));

            new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'TRMB Share Price in SEK',
                        data: mergedData,
                        borderColor: 'yellow',
                        backgroundColor: 'yellow',
                        tension: 0.1,
                        yAxisID: 'y'
                    }, {
                        label: 'Three-month Average',
                        data: [
                            { x: mergedData[0].x, y: averagePriceSEK },
                            { x: mergedData[mergedData.length - 1].x, y: averagePriceSEK }
                        ],
                        borderColor: 'grey',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                displayFormats: {
                                    month: 'MMM d'
                                }
                            },
                            title: {
                                display: false
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    const date = new Date(value);
                                    if (date.getDate() === 1) {
                                        return date.toLocaleString('en-US', { month: 'short', day: 'numeric' });
                                    }
                                    return '';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price (SEK)',
                                color: 'grey'  // Match the TRMB line color
                            },
                            position: 'left',
                            min: minPrice,
                            max: maxPrice,
                            ticks: {
                                callback: function(value, index, values) {
                                    if (index === 0 || index === values.length - 1) {
                                        return '';
                                    }
                                    return value.toFixed(0);
                                },
                                color: 'grey'  // Match the TRMB line color
                            }
                        },
                        y1: {
                            title: {
                                display: true,
                                text: '% Deviation',
                                color: 'grey'  // Match the TRMB line color
                            },
                            position: 'right',
                            min: minPercent,
                            max: maxPercent,
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    if (Number.isInteger(value)) {
                                        return value > 0 ? `+${value}%` : `${value}%`;
                                    }
                                    return '';
                                },
                                color: 'grey'  // Match the TRMB line color
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Three-month Average') {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} SEK`;
                                    }
                                    const price = context.raw.y.toFixed(2);
                                    const percent = context.raw.y1.toFixed(2);
                                    return `Price: ${price} SEK, Deviation: ${percent > 0 ? '+' : ''}${percent}%`;
                                }
                            }
                        },
                        legend: {
                            labels: {
                                filter: function(item, chart) {
                                    // Hide the "Three-month Average" from the legend
                                    return item.text !== 'Three-month Average';
                                }
                            }
                        }
                    }
                },
                plugins: [{
                    id: 'customCanvasBackgroundColor',
                    beforeDraw: (chart, args, options) => {
                        const {ctx} = chart;
                        ctx.save();
                        ctx.globalCompositeOperation = 'destination-over';
                        ctx.fillStyle = 'lightblue';
                        ctx.fillRect(0, 0, chart.width, chart.height);
                        ctx.restore();
                    },
                }]
            });
        }

        function createNasdaqChart(timestamps, trmbPrices, nasdaqData) {
            const ctx = document.getElementById('nasdaqChart').getContext('2d');
            
            const trmbData = timestamps.map((ts, index) => ({
                x: new Date(ts * 1000),
                y: trmbPrices[index]
            }));

            new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'NASDAQ',
                        data: nasdaqData,
                        borderColor: 'black',
                        backgroundColor: 'black',
                        yAxisID: 'y',
                        tension: 0.1
                    }, {
                        label: 'TRMB',
                        data: trmbData,
                        borderColor: 'blue',
                        backgroundColor: 'blue',
                        yAxisID: 'y1',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                displayFormats: {
                                    month: 'MMM d'
                                }
                            },
                            title: {
                                display: false
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    const date = new Date(value);
                                    if (date.getDate() === 1) {
                                        return date.toLocaleString('en-US', { month: 'short', day: 'numeric' });
                                    }
                                    return '';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'NASDAQ',
                                color: 'black'  // Match the NASDAQ line color
                            },
                            position: 'left',
                            ticks: {
                                color: 'black'  // Match the NASDAQ line color
                            }
                        },
                        y1: {
                            title: {
                                display: true,
                                text: 'TRMB Price',
                                color: 'blue'  // Match the TRMB line color
                            },
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                color: 'blue'  // Match the TRMB line color
                            }
                        }
                    }
                }
            });
        }

        fetchStockData();
    </script>
</body>
</html>
